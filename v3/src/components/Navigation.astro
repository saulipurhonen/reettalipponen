---
import { UI_STRINGS, DEFAULT_LOCALE } from "../lib/i18n"

const navItems = UI_STRINGS[DEFAULT_LOCALE].navigation
const pathname = Astro.url.pathname

function isActive(href: string): boolean {
  if (href === "/") {
    return pathname === "/"
  }
  return pathname.startsWith(href)
}
---

<header class="relative z-50">
  <a
    href="#main-content"
    class="sr-only focus:not-sr-only focus:absolute focus:z-[70] focus:top-2 focus:left-2 focus:rounded focus:bg-white focus:px-4 focus:py-2 focus:text-black focus:text-sm focus:font-semibold"
  >
    Siirry sisältöön
  </a>
  <nav
    aria-label="Päävalikko"
    class="mx-auto flex max-w-6xl items-center justify-between px-4 py-4"
  >
    <!-- Logo -->
    <a
      href="/"
      class="text-lg font-semibold tracking-wide text-white"
      aria-label="Etusivu – reettalipponen.ART"
    >
      reettalipponen<span class="text-emerald-400">.ART</span>
    </a>

    <!-- Desktop nav -->
    <ul class="hidden md:flex md:items-center md:gap-6">
      {
        navItems.map((item) => (
          <li>
            <a
              href={item.href}
              class:list={[
                "text-sm transition-colors",
                isActive(item.href)
                  ? "text-emerald-400 font-semibold border-b-4 border-emerald-400/50 pb-1"
                  : "text-gray-300 hover:text-emerald-500",
              ]}
              {...(isActive(item.href) ? { "aria-current": "page" } : {})}
            >
              {item.label}
            </a>
          </li>
        ))
      }
    </ul>

    <!-- Mobile hamburger button -->
    <button
      id="menu-toggle"
      class="relative z-50 md:hidden p-2 group ml-auto"
      type="button"
      aria-label="Avaa valikko"
      aria-expanded="false"
      aria-controls="mobile-menu"
    >
      <div class="relative h-3.5 w-5">
        <span
          id="bar-1"
          class="absolute left-0 top-0 block h-0.5 w-5 bg-current transition-all duration-300 ease-in-out"
        ></span>
        <span
          id="bar-2"
          class="absolute left-0 top-[6px] block h-0.5 w-5 bg-current transition-all duration-300 ease-in-out"
        ></span>
        <span
          id="bar-3"
          class="absolute left-0 bottom-0 block h-0.5 w-5 bg-current transition-all duration-300 ease-in-out"
        ></span>
      </div>
    </button>
  </nav>

  <!-- Mobile overlay -->
  <nav
    id="mobile-menu"
    aria-label="Mobiilivalikko"
    class="fixed inset-0 z-40 hidden flex-col items-center justify-center bg-black"
  >
    <ul class="flex flex-col items-center gap-6">
      {
        navItems.map((item) => (
          <li>
            <a
              href={item.href}
              class:list={[
                "mobile-nav-link text-lg transition-colors",
                isActive(item.href)
                  ? "text-emerald-400 font-semibold border-b-4 border-emerald-400/50 pb-1"
                  : "text-gray-300 hover:text-emerald-500",
              ]}
              {...(isActive(item.href) ? { "aria-current": "page" } : {})}
            >
              {item.label}
            </a>
          </li>
        ))
      }
    </ul>
  </nav>
</header>

<script>
  import gsap from "gsap"

  document.addEventListener("astro:page-load", () => {
    const toggle = document.getElementById("menu-toggle")
    const menu = document.getElementById("mobile-menu")
    const bar1 = document.getElementById("bar-1")
    const bar2 = document.getElementById("bar-2")
    const bar3 = document.getElementById("bar-3")
    const mobileLinks = document.querySelectorAll(".mobile-nav-link")
    let isAnimating = false

    function openMenu() {
      if (isAnimating) return
      isAnimating = true

      menu?.classList.remove("hidden")
      menu?.classList.add("flex")
      bar1?.classList.add("top-[6px]", "rotate-45")
      bar1?.classList.remove("top-0")
      bar2?.classList.add("opacity-0")
      bar3?.classList.add("bottom-[6px]", "-rotate-45")
      bar3?.classList.remove("bottom-0")
      toggle?.setAttribute("aria-expanded", "true")
      toggle?.setAttribute("aria-label", "Sulje valikko")

      gsap.fromTo(
        menu,
        { opacity: 0, y: 40 },
        {
          opacity: 1,
          y: 0,
          duration: 0.3,
          ease: "power2.out",
          onComplete: () => {
            isAnimating = false
          },
        }
      )
    }

    function closeMenu() {
      if (isAnimating) return
      isAnimating = true

      bar1?.classList.remove("top-[6px]", "rotate-45")
      bar1?.classList.add("top-0")
      bar2?.classList.remove("opacity-0")
      bar3?.classList.remove("bottom-[6px]", "-rotate-45")
      bar3?.classList.add("bottom-0")
      toggle?.setAttribute("aria-expanded", "false")
      toggle?.setAttribute("aria-label", "Avaa valikko")

      gsap.to(menu, {
        opacity: 0,
        y: -40,
        duration: 0.3,
        ease: "power2.in",
        onComplete: () => {
          menu?.classList.add("hidden")
          menu?.classList.remove("flex")
          gsap.set(menu, { clearProps: "all" })
          isAnimating = false
        },
      })
    }

    toggle?.addEventListener("click", () => {
      const isOpen = toggle.getAttribute("aria-expanded") === "true"
      if (isOpen) {
        closeMenu()
      } else {
        openMenu()
      }
    })

    mobileLinks.forEach((link) => {
      link.addEventListener("click", () => {
        closeMenu()
      })
    })

    // Escape key closes mobile menu
    document.addEventListener("keydown", (e) => {
      if (
        e.key === "Escape" &&
        toggle?.getAttribute("aria-expanded") === "true"
      ) {
        closeMenu()
        toggle?.focus()
      }
    })

    // Focus trap inside mobile menu
    menu?.addEventListener("keydown", (e) => {
      if (e.key !== "Tab") return
      const focusableEls = menu.querySelectorAll<HTMLElement>(
        "a[href], button:not([disabled])"
      )
      if (!focusableEls.length) return
      const first = focusableEls[0]
      const last = focusableEls[focusableEls.length - 1]
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault()
        last.focus()
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault()
        first.focus()
      }
    })
  })
</script>
